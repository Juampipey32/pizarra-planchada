<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizarra Log√≠stica</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="bg-slate-100 h-screen flex flex-col font-sans text-slate-900 overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm z-40">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600 p-1.5 rounded text-white shadow-lg shadow-blue-200">
                <i data-lucide="truck" class="w-5 h-5"></i>
            </div>
            <h1 class="text-lg font-bold text-slate-800 hidden md:block">Log√≠stica <span
                    class="text-blue-600">Pro</span></h1>
        </div>

        <div class="flex items-center bg-slate-100 rounded-lg p-0.5 border border-slate-200 shadow-inner">
            <button id="prevDay" class="p-1.5 hover:bg-white rounded transition text-slate-500"><i
                    data-lucide="chevron-left" class="w-4 h-4"></i></button>
            <div
                class="flex items-center gap-2 px-4 py-1 min-w-[180px] justify-center font-semibold text-sm text-slate-700">
                <i data-lucide="calendar" class="w-3 h-3 text-blue-500"></i>
                <span id="currentDateDisplay" class="capitalize">Hoy</span>
            </div>
            <button id="nextDay" class="p-1.5 hover:bg-white rounded transition text-slate-500"><i
                    data-lucide="chevron-right" class="w-4 h-4"></i></button>
        </div>

        <div class="flex items-center gap-2">
            <span id="userRoleDisplay"
                class="text-xs font-bold px-2 py-1 rounded bg-slate-200 text-slate-600 uppercase"></span>
            <button id="bulkUploadBtn" class="hidden text-xs font-bold px-3 py-1.5 rounded bg-green-100 text-green-700 border border-green-200 hover:bg-green-200 transition flex items-center gap-1"
                title="Carga Masiva">
                <i data-lucide="upload" class="w-4 h-4"></i>
                Carga Masiva
            </button>
            <a id="adminLink" href="/admin-products.html" class="hidden text-xs font-bold px-2 py-1 rounded bg-amber-100 text-amber-700 border border-amber-200">Productos</a>
            <button id="logoutBtn" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-full transition"
                title="Cerrar Sesion">
                <i data-lucide="log-out" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Main Grid -->
    <main class="flex-1 overflow-auto relative" id="mainContainer">
        <div class="min-w-[800px] h-full">
            <!-- Grid Header (Resources) -->
            <div class="grid grid-cols-[60px_repeat(5,1fr)] sticky top-0 z-30 bg-slate-50 border-b border-slate-200 shadow-sm"
                id="gridHeader">
                <div class="p-3 border-r border-slate-200 flex justify-center items-center">
                    <i data-lucide="clock" class="w-4 h-4 text-slate-300"></i>
                </div>
                <!-- Resources injected by JS -->
            </div>

            <!-- Grid Body (Time Slots) -->
            <div class="pb-20" id="gridBody">
                <!-- Slots injected by JS -->
            </div>
        </div>
    </main>

    <!-- Booking Modal (Create) -->
    <div id="bookingModal"
        class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4 backdrop-blur-sm overflow-y-auto">
        <div
            class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden animate-in fade-in zoom-in duration-200 my-auto">
            <div class="bg-blue-600 p-4 flex justify-between items-center text-white sticky top-0 z-10">
                <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="plus" class="w-5 h-5"></i> Nueva
                    Carga</h3>
                <button onclick="closeModal('bookingModal')"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                <!-- Tabs -->
                <div class="flex border-b border-slate-200 mb-4" id="modalTabs">
                    <button onclick="setModalMode('drop')"
                        class="flex-1 pb-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600"
                        id="tabDrop">Subir PDF</button>
                    <button onclick="setModalMode('manual')" class="flex-1 pb-2 text-sm font-medium text-slate-400"
                        id="tabManual">Manual</button>
                </div>

                <!-- Drop Zone -->
                <div id="modeDrop" class="space-y-4">
                    <div id="dropZone"
                        class="border-2 border-dashed border-slate-300 rounded-xl h-40 flex flex-col items-center justify-center transition-all cursor-pointer relative hover:border-blue-500 hover:bg-blue-50">
                        <input type="file" id="pdfInput" accept=".pdf"
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div id="dropContent" class="text-center text-slate-500">
                            <i data-lucide="upload-cloud" class="w-8 h-8 mx-auto mb-2"></i>
                            Arrastra PDF aqu√≠
                        </div>
                        <div id="uploadingSpinner" class="hidden animate-pulse text-blue-600 font-bold">Procesando...
                        </div>
                    </div>
                </div>

                <!-- Manual Form -->
                <form id="bookingForm" class="space-y-4 hidden">
                    <input type="hidden" id="newResourceId">
                    <input type="hidden" id="newTimeSlotHour">
                    <input type="hidden" id="newTimeSlotMinute">

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Hora</label>
                            <div id="timeSlotDisplay" class="text-sm bg-slate-100 p-2 rounded font-mono font-bold text-slate-700">--:--</div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">
                                Carga (Kg)
                                <span id="kgBadge" class="hidden ml-1 text-[10px] bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded-full font-normal">Auto</span>
                            </label>
                            <input type="number" id="newKg" class="w-full p-2 border border-slate-300 rounded text-sm font-bold" placeholder="0">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cliente</label>
                        <input type="text" id="newClient" required class="w-full p-2 border border-slate-300 rounded text-sm font-semibold">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cod Cliente</label>
                            <input type="text" id="newClientCode" class="w-full p-2 border border-slate-300 rounded text-sm font-mono" placeholder="C4099">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">N¬∞ Pedido</label>
                            <input type="text" id="newOrderNumber" class="w-full p-2 border border-slate-300 rounded text-sm font-mono" placeholder="918.284">
                        </div>
                    </div>

                    <!-- Products Table -->
                    <div id="productsSection" class="hidden">
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-xs font-bold text-slate-500 uppercase flex items-center gap-2">
                                Productos
                                <span id="productCount" class="text-[10px] bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full font-normal">0</span>
                            </label>
                            <button type="button" onclick="addProductRow()" class="text-xs text-blue-600 hover:text-blue-700 font-bold flex items-center gap-1 transition-colors">
                                <i data-lucide="plus-circle" class="w-3.5 h-3.5"></i> Agregar
                            </button>
                        </div>
                        <div class="border border-slate-200 rounded-lg overflow-hidden max-h-48 overflow-y-auto shadow-sm">
                            <table class="w-full text-xs">
                                <thead class="bg-gradient-to-r from-slate-50 to-slate-100 sticky top-0">
                                    <tr class="text-left border-b border-slate-200">
                                        <th class="p-2 font-bold text-slate-600 w-20">C√≥digo</th>
                                        <th class="p-2 font-bold text-slate-600 w-16 text-right">Cant.</th>
                                        <th class="p-2 font-bold text-slate-600 w-14 text-right">Coef.</th>
                                        <th class="p-2 font-bold text-slate-600 w-20 text-right">Kg</th>
                                        <th class="p-2 w-8"></th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody" class="divide-y divide-slate-100 bg-white">
                                    <!-- Products will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2 flex justify-between items-center bg-gradient-to-r from-blue-50 to-blue-100 p-3 rounded-lg border border-blue-200">
                            <span class="text-xs font-bold text-slate-700">TOTAL:</span>
                            <span id="totalKgDisplay" class="text-base font-bold text-blue-700">0 kg</span>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Observaciones (opcional)</label>
                        <textarea id="newObservations"
                            class="w-full p-2 border border-slate-300 rounded h-16 text-sm resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Notas adicionales para la carga..."></textarea>
                    </div>

                    <div class="bg-gradient-to-br from-slate-50 to-slate-100 p-3 rounded-lg grid grid-cols-2 gap-4 border border-slate-200">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tiempo</label>
                            <select id="newDuration" class="w-full p-2 border border-slate-300 rounded text-sm font-semibold focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="30">30m</option>
                                <option value="60">1h</option>
                                <option value="90">1h 30m</option>
                                <option value="120">2h</option>
                                <option value="150">2h 30m</option>
                                <option value="180">3h</option>
                                <option value="240">4h</option>
                                <option value="300">5h</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Prioridad</label>
                            <select id="newColor" class="w-full p-2 border border-slate-300 rounded text-sm font-semibold focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="blue">üîµ Normal</option>
                                <option value="red">üî¥ Urgente</option>
                                <option value="green">üü¢ Lista</option>
                                <option value="orange">üü† Espera</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit"
                        class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold py-3 rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all shadow-md hover:shadow-lg">
                        <span class="flex items-center justify-center gap-2">
                            <i data-lucide="check-circle" class="w-4 h-4"></i>
                            Confirmar Carga
                        </span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulkUploadModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden animate-in zoom-in duration-200 my-auto flex flex-col">
            <div class="bg-gradient-to-r from-green-600 to-emerald-600 p-4 flex justify-between items-center text-white sticky top-0 z-10">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <i data-lucide="upload-cloud" class="w-5 h-5"></i> Carga Masiva de Pedidos
                </h3>
                <button onclick="closeModal('bulkUploadModal')"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>

            <div class="p-6 overflow-y-auto flex-1">
                <!-- Step 1: Upload Excel -->
                <div id="bulkStep1" class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <h4 class="font-bold text-blue-900 mb-2 flex items-center gap-2">
                            <i data-lucide="info" class="w-4 h-4"></i> Instrucciones
                        </h4>
                        <ul class="text-sm text-blue-800 space-y-1 list-disc ml-5">
                            <li>Sube un archivo Excel (.xlsx) con los pedidos</li>
                            <li>El sistema detectar√° autom√°ticamente todos los pedidos</li>
                            <li>Podr√°s configurar horarios para cada pedido</li>
                            <li>Los pedidos sin horario configurado no se crear√°n</li>
                        </ul>
                    </div>

                    <div id="bulkDropZone"
                        class="border-2 border-dashed border-green-300 rounded-xl h-48 flex flex-col items-center justify-center transition-all cursor-pointer relative hover:border-green-500 hover:bg-green-50">
                        <input type="file" id="bulkExcelInput" accept=".xlsx,.xls"
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div id="bulkDropContent" class="text-center text-slate-500">
                            <i data-lucide="upload-cloud" class="w-12 h-12 mx-auto mb-3 text-green-500"></i>
                            <p class="font-bold text-lg text-slate-700">Arrastra Excel aqu√≠</p>
                            <p class="text-sm">o haz click para seleccionar</p>
                        </div>
                        <div id="bulkUploadingSpinner" class="hidden animate-pulse text-green-600 font-bold">
                            Procesando Excel...
                        </div>
                    </div>
                </div>

                <!-- Step 2: Preview & Configure -->
                <div id="bulkStep2" class="hidden space-y-4">
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-bold text-green-900 flex items-center gap-2">
                                    <i data-lucide="check-circle" class="w-5 h-5"></i>
                                    <span id="bulkOrderCount">0</span> pedidos detectados
                                </h4>
                                <p class="text-sm text-green-700 mt-1">Configura horario y puerta para cada pedido que deseas crear</p>
                            </div>
                            <button onclick="backToBulkUpload()" class="text-sm px-3 py-1.5 bg-white border border-green-300 rounded hover:bg-green-50 transition">
                                Cambiar Archivo
                            </button>
                        </div>
                    </div>

                    <!-- Date Selector -->
                    <div class="flex items-center gap-4 bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <label class="font-bold text-slate-700 text-sm">Fecha:</label>
                        <input type="date" id="bulkDate" class="px-3 py-2 border border-slate-300 rounded font-mono text-sm">
                        <button onclick="applyDateToAll()" class="ml-auto text-xs px-3 py-1.5 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition">
                            Aplicar a todos
                        </button>
                    </div>

                    <!-- Orders Table -->
                    <div class="border border-slate-200 rounded-lg overflow-hidden shadow-lg">
                        <div class="max-h-[400px] overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gradient-to-r from-slate-100 to-slate-200 sticky top-0 z-10">
                                    <tr class="text-left border-b-2 border-slate-300">
                                        <th class="p-3 font-bold text-slate-700 w-8">
                                            <input type="checkbox" id="selectAllOrders" onchange="toggleAllOrders(this.checked)" class="w-4 h-4">
                                        </th>
                                        <th class="p-3 font-bold text-slate-700">Cliente</th>
                                        <th class="p-3 font-bold text-slate-700">Pedido</th>
                                        <th class="p-3 font-bold text-slate-700 text-right">Kg</th>
                                        <th class="p-3 font-bold text-slate-700">Descripci√≥n</th>
                                        <th class="p-3 font-bold text-slate-700 w-32">Puerta</th>
                                        <th class="p-3 font-bold text-slate-700 w-28">Hora</th>
                                        <th class="p-3 font-bold text-slate-700 w-24">Duraci√≥n</th>
                                        <th class="p-3 font-bold text-slate-700 w-8"></th>
                                    </tr>
                                </thead>
                                <tbody id="bulkOrdersTableBody" class="divide-y divide-slate-100 bg-white">
                                    <!-- Orders will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="bulkValidationErrors" class="hidden bg-red-50 border border-red-300 rounded-lg p-4">
                        <h5 class="font-bold text-red-900 mb-2 flex items-center gap-2">
                            <i data-lucide="alert-triangle" class="w-4 h-4"></i> Errores de validaci√≥n
                        </h5>
                        <ul id="bulkValidationErrorsList" class="text-sm text-red-800 space-y-1 list-disc ml-5">
                        </ul>
                    </div>

                    <div class="flex gap-3 pt-4 border-t border-slate-200">
                        <button onclick="closeModal('bulkUploadModal')" class="px-6 py-2.5 border border-slate-300 rounded-lg hover:bg-slate-50 transition">
                            Cancelar
                        </button>
                        <button onclick="confirmBulkCreate()" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold py-2.5 rounded-lg hover:from-green-700 hover:to-emerald-700 transition shadow-lg">
                            <span class="flex items-center justify-center gap-2">
                                <i data-lucide="check-circle" class="w-5 h-5"></i>
                                Crear <span id="selectedOrdersCount">0</span> Pedidos Seleccionados
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden animate-in zoom-in duration-200 my-auto">
            <div class="bg-slate-800 p-4 flex justify-between items-center text-white sticky top-0 z-10">
                <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="edit-2" class="w-4 h-4"></i>
                    Editar Carga</h3>
                <button onclick="closeModal('editModal')"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form id="editForm" class="p-6 space-y-4 overflow-y-auto max-h-[calc(90vh-80px)]">
                <input type="hidden" id="editId">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cliente</label><input
                            type="text" id="editClient" class="w-full p-2 border border-slate-300 rounded font-bold">
                    </div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Carga (Kg)</label><input
                            type="number" id="editKg" class="w-full p-2 border border-slate-300 rounded"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cod Cliente</label><input
                            type="text" id="editClientCode" class="w-full p-2 border border-slate-300 rounded"></div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">N¬∞ Pedido</label><input
                            type="text" id="editOrderNumber" class="w-full p-2 border border-slate-300 rounded"></div>
                </div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Detalle</label><textarea
                        id="editDescription" class="w-full p-2 border border-slate-300 rounded text-sm h-16"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4 bg-slate-50 p-3 rounded border border-slate-200">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Duraci√≥n</label>
                        <select id="editDuration"
                            class="w-full p-2 border border-blue-200 rounded font-bold text-blue-900">
                            <option value="30">30m</option>
                            <option value="60">1h</option>
                            <option value="90">1h 30m</option>
                            <option value="120">2h</option>
                            <option value="150">2h 30m</option>
                            <option value="180">3h</option>
                            <option value="240">4h</option>
                            <option value="300">5h</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Prioridad</label>
                        <select id="editColor" class="w-full p-2 border border-slate-300 rounded">
                            <option value="blue">Normal</option>
                            <option value="red">Urgente</option>
                            <option value="green">Lista</option>
                            <option value="orange">Espera</option>
                        </select>
                    </div>
                </div>

                <!-- Real Time Controls -->
                <div class="border-t-2 border-slate-100 pt-4 mt-2">
                    <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2"><i data-lucide="clock"
                            class="w-4 h-4 text-slate-400"></i> Horario Real de Operaci√≥n</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-green-600 uppercase mb-1 flex items-center gap-1">
                                <i data-lucide="log-in" class="w-3 h-3"></i> Hora Llegada
                            </label>
                            <input type="time" id="editRealStartTime"
                                class="w-full p-2 border border-green-200 bg-green-50 rounded font-mono text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-blue-600 uppercase mb-1 flex items-center gap-1">
                                <i data-lucide="log-out" class="w-3 h-3"></i> Hora Salida (auto)
                            </label>
                            <input type="text" id="editRealEndTimeDisplay" readonly
                                class="w-full p-2 border border-blue-200 bg-blue-50 rounded font-mono text-sm text-slate-500"
                                placeholder="Se calcula autom√°tico">
                            <input type="hidden" id="editRealEndTime">
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-2 italic">
                        üí° La hora de salida se calcula autom√°ticamente sumando la duraci√≥n a la hora de llegada
                    </p>
                </div>

                <div class="flex gap-2 pt-2">
                    <button type="button" id="deleteBtn"
                        class="px-4 py-2 text-red-500 hover:bg-red-50 border border-red-200 rounded">Eliminar</button>
                    <button type="submit"
                        class="flex-1 bg-slate-900 text-white font-bold py-2 rounded shadow hover:bg-slate-800">Guardar
                        Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Logic -->
    <script>
        // Constants
        const RESOURCES = [
            { id: 'p1', name: 'Puerta 1', type: 'dock' },
            { id: 'p2', name: 'Puerta 2', type: 'dock' },
            { id: 'p3', name: 'Puerta 3', type: 'dock' },
            { id: 'p4', name: 'Puerta 4', type: 'dock' },
            { id: 'sampi', name: 'Sampi', type: 'machinery' },
        ];
        const START_HOUR = 4;
        const END_HOUR = 20;
        const formatKg = (kg) => {
            if (!kg || Number.isNaN(kg)) return '';
            const val = Math.round(parseFloat(kg) * 100) / 100;
            return `${val}kg`;
        };
        let productMap = {};
        let currentProducts = []; // Products for current booking

        // State
        let currentDate = new Date();
        let bookings = [];
        let userRole = localStorage.getItem('role') || 'VISUALIZADOR';
        let token = localStorage.getItem('token');

        async function loadProductCoefficients() {
            try {
                const res = await fetch('/api/products', { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) return;
                const data = await res.json();
                productMap = {};
                data.forEach(p => { productMap[p.code] = parseFloat(p.coefficient); });
            } catch (_) {
                // ignore, we fall back to coef 1
            }
        }

        function suggestDuration(kgTotal) {
            if (!kgTotal || kgTotal <= 0) return 30;
            const minutes = Math.ceil(((kgTotal / 2000) * 60) / 30) * 30;
            return Math.max(30, minutes);
        }

        // PDF parsing now delegated to backend (upload.php) to avoid CDN/worker issues on hosting.

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            if (!token) window.location.href = '/index.html';

            document.getElementById('userRoleDisplay').textContent = userRole;
            const adminLink = document.getElementById('adminLink');
            const bulkUploadBtn = document.getElementById('bulkUploadBtn');
            if (userRole === 'VENDEDOR') {
                adminLink.classList.remove('hidden');
                bulkUploadBtn.classList.remove('hidden');
            }
            lucide.createIcons();
            renderGridHeader();
            renderGridBody();
            loadBookings();
            loadProductCoefficients();

            // Event Listeners
            document.getElementById('prevDay').onclick = () => changeDate(-1);
            document.getElementById('nextDay').onclick = () => changeDate(1);
            document.getElementById('logoutBtn').onclick = () => {
                localStorage.clear();
                window.location.href = '/index.html';
            };

            // Modal Events
            document.getElementById('pdfInput').onchange = handleFileUpload;
            document.getElementById('bookingForm').onsubmit = handleCreateBooking;
            document.getElementById('editForm').onsubmit = handleUpdateBooking;
            document.getElementById('deleteBtn').onclick = handleDeleteBooking;

            // Auto-calc duration based on kg (simple version)
            document.getElementById('newKg').oninput = (e) => autoCalcDuration(e.target.value, 'newDuration');
            document.getElementById('editKg').oninput = (e) => autoCalcDuration(e.target.value, 'editDuration');

            // Auto-calc end time when start time changes
            document.getElementById('editRealStartTime').oninput = (e) => calculateEndTime();
            document.getElementById('editDuration').onchange = (e) => calculateEndTime();

            // Bulk upload events
            document.getElementById('bulkUploadBtn').onclick = openBulkUploadModal;
            document.getElementById('bulkExcelInput').onchange = handleBulkExcelUpload;
        });

        function changeDate(days) {
            currentDate.setDate(currentDate.getDate() + days);
            loadBookings();
        }

        async function loadBookings() {
            const dateStr = currentDate.toISOString().split('T')[0];
            document.getElementById('currentDateDisplay').textContent = currentDate.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'long' });

            try {
                const res = await fetch(`/api/bookings?date=${dateStr}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.status === 401) {
                    localStorage.clear();
                    window.location.href = '/index.html';
                    return;
                }
                if (res.ok) {
                    bookings = await res.json();
                    renderGridBody(); // Re-render to place bookings
                }
            } catch (e) { console.error(e); }
        }

        function renderGridHeader() {
            const header = document.getElementById('gridHeader');
            RESOURCES.forEach(r => {
                const div = document.createElement('div');
                div.className = 'p-2 text-center border-r border-slate-200 last:border-r-0 bg-slate-50';
                div.innerHTML = `<div class="font-bold text-base ${r.type === 'machinery' ? 'text-amber-700' : 'text-slate-700'}">${r.name}</div>`;
                header.appendChild(div);
            });
        }

        function renderGridBody() {
            const body = document.getElementById('gridBody');
            body.innerHTML = '';

            for (let h = START_HOUR; h < END_HOUR; h++) {
                [0, 30].forEach(m => {
                    const row = document.createElement('div');
                    row.className = 'grid grid-cols-[60px_repeat(5,1fr)] hover:bg-blue-50/20 group';

                    // Time Label
                    const timeLabel = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    row.innerHTML = `<div class="h-[60px] flex items-center justify-center text-xs font-bold text-slate-500 border-r border-b border-slate-200 bg-white sticky left-0 z-20">${timeLabel}</div>`;

                    RESOURCES.forEach(r => {
                        const cell = document.createElement('div');
                        cell.className = 'relative h-[60px] border-r border-b border-slate-200 last:border-r-0';
                        cell.innerHTML = `<div class="absolute top-1/2 w-full border-t border-dotted border-slate-100"></div>`;

                        // Find bookings starting here
                        const cellBookings = bookings.filter(b => b.resourceId === r.id && b.startTimeHour === h && b.startTimeMinute === m);
                        cellBookings.forEach(b => {
                            const card = createBookingCard(b);
                            cell.appendChild(card);
                        });

                        // Add Button (Only VENDEDOR can create)
                        if (cellBookings.length === 0 && userRole === 'VENDEDOR') {
                            const btn = document.createElement('button');
                            btn.className = 'absolute inset-0 w-full h-full opacity-0 group-hover:opacity-100 flex items-center justify-center z-0 transition';
                            btn.innerHTML = `<div class="bg-blue-100 text-blue-600 rounded-full p-1 shadow-sm transform scale-75 hover:scale-100"><i data-lucide="plus" class="w-6 h-6"></i></div>`;
                            btn.onclick = () => openCreateModal(r.id, h, m, timeLabel);
                            cell.appendChild(btn);
                        }

                        row.appendChild(cell);
                    });
                    body.appendChild(row);
                });
            }
            lucide.createIcons();
        }

        function createBookingCard(b) {
            const height = (b.duration / 30) * 60;
            const styles = {
                blue: 'bg-blue-100 border-blue-600 text-blue-950 shadow-blue-200',
                red: 'bg-red-100 border-red-600 text-red-950 shadow-red-200',
                green: 'bg-green-100 border-green-600 text-green-950 shadow-green-200',
                orange: 'bg-amber-100 border-amber-600 text-amber-950 shadow-amber-200'
            };
            const style = styles[b.color] || styles.blue;

            // VISUALIZADOR Logic: Mask data
            const isVisualizador = userRole === 'VISUALIZADOR';
            const displayClient = isVisualizador ? 'OCUPADO' : b.client;
            const displayClientCode = isVisualizador ? '' : (b.clientCode || '');
            const displayOrder = isVisualizador ? '' : (b.orderNumber || '');
            const displayKg = b.kg > 0 ? formatKg(b.kg) : '';
            const displayDesc = isVisualizador ? '' : (b.description || '');

            const div = document.createElement('div');
            // Enhanced 3D effect: border-l-4, shadow-lg, transform hover
            // Reduced padding (p-1.5) and text size (text-xs) to fit better
            div.className = `absolute inset-x-1 p-1.5 rounded-r-md border-l-[6px] shadow-lg text-xs overflow-hidden cursor-pointer group transition-all z-10 hover:scale-[1.02] hover:z-20 ${style}`;
            div.style.height = `${height - 4}px`;
            div.style.top = '2px';

            if (!isVisualizador && userRole !== 'PLANCHADA') {
                div.onclick = (e) => { e.stopPropagation(); openEditModal(b); };
            } else if (userRole === 'PLANCHADA') {
                div.onclick = (e) => { e.stopPropagation(); openEditModal(b); };
            }

            div.innerHTML = `
            <div class="flex justify-between items-start mb-0.5">
                <span class="font-black truncate w-full text-[11px] uppercase tracking-tight flex items-center gap-1 leading-tight">
                    ${displayClientCode ? `<span class="px-1 py-0.5 rounded bg-white/50 text-[10px] font-bold">${displayClientCode}</span>` : ''}
                    ${displayClient}
                </span>
            </div>
            <div class="flex gap-1 mb-0.5 items-center flex-wrap">
                ${displayOrder ? `<span class="text-[10px] px-1.5 py-0.5 rounded-md font-bold bg-white/60 leading-none">Pedido ${displayOrder}</span>` : ''}
                ${displayKg ? `<span class="text-[10px] px-1.5 py-0.5 rounded-md font-extrabold shadow-sm bg-white/60 leading-none">${displayKg}</span>` : ''}
                <span class="text-[10px] font-bold opacity-80 font-mono flex items-center gap-0.5 leading-none">
                    <i data-lucide="clock" class="w-3 h-3"></i> ${Math.floor(b.duration / 60)}h${b.duration % 60 || ''}
                </span>
            </div>
            ${!isVisualizador ? `<div class="font-medium truncate text-[10px] leading-tight opacity-90">${displayDesc}</div>` : ''}
            ${(b.realStartTime || b.realEndTime) ? `<div class="mt-0.5 text-[9px] font-mono bg-black/10 px-1 rounded inline-block leading-none">Real: ${b.realStartTime || '--'} - ${b.realEndTime || '--'}</div>` : ''}
        `;
            return div;
        }

        // Modal Logic
        function openCreateModal(rId, h, m, label) {
            document.getElementById('newResourceId').value = rId;
            document.getElementById('newTimeSlotHour').value = h;
            document.getElementById('newTimeSlotMinute').value = m;
            document.getElementById('timeSlotDisplay').textContent = label;

            // Reset form
            document.getElementById('newClient').value = '';
            document.getElementById('newKg').value = '';
            document.getElementById('newClientCode').value = '';
            document.getElementById('newOrderNumber').value = '';
            document.getElementById('newObservations').value = '';
            document.getElementById('newDuration').value = '30';
            document.getElementById('newColor').value = 'blue';

            // Reset products
            currentProducts = [];
            renderProductsTable();

            setModalMode('drop');
            document.getElementById('bookingModal').classList.remove('hidden');
            document.getElementById('bookingModal').classList.add('flex');
        }

        function openEditModal(b) {
            if (userRole === 'VISUALIZADOR') return; // Should not happen due to click handler, but safety check

            document.getElementById('editId').value = b.id;

            // Fields
            const clientInput = document.getElementById('editClient');
            const kgInput = document.getElementById('editKg');
            const descInput = document.getElementById('editDescription');
            const durInput = document.getElementById('editDuration');
            const colorInput = document.getElementById('editColor');
            const startInput = document.getElementById('editRealStartTime');
            const endInput = document.getElementById('editRealEndTime');
            const deleteBtn = document.getElementById('deleteBtn');
            const saveBtn = document.querySelector('#editForm button[type="submit"]');
            const clientCodeInput = document.getElementById('editClientCode');
            const orderNumberInput = document.getElementById('editOrderNumber');

            // Populate
            clientInput.value = b.client;
            kgInput.value = b.kg;
            descInput.value = b.description;
            durInput.value = b.duration;
            colorInput.value = b.color;
            startInput.value = b.realStartTime || '';
            endInput.value = b.realEndTime || '';
            clientCodeInput.value = b.clientCode || '';
            orderNumberInput.value = b.orderNumber || '';

            // Permissions
            if (userRole === 'PLANCHADA') {
                // Disable operational fields
                clientInput.disabled = true;
                kgInput.disabled = true;
                descInput.disabled = true;
                durInput.disabled = true;
                colorInput.disabled = true;
                clientCodeInput.disabled = true;
                orderNumberInput.disabled = true;

                // Enable Real Time
                startInput.disabled = false;
                endInput.disabled = false;

                // Hide Delete
                deleteBtn.classList.add('hidden');

                // Visual cue
                saveBtn.textContent = "Actualizar Horario Real";
                saveBtn.classList.remove('bg-slate-900');
                saveBtn.classList.add('bg-amber-700');
            } else {
                // VENDEDOR: Enable all
                clientInput.disabled = false;
                kgInput.disabled = false;
                descInput.disabled = false;
                durInput.disabled = false;
                colorInput.disabled = false;
                clientCodeInput.disabled = false;
                orderNumberInput.disabled = false;
                startInput.disabled = false;
                endInput.disabled = false;

                deleteBtn.classList.remove('hidden');
                saveBtn.textContent = "Guardar Cambios";
                saveBtn.classList.remove('bg-amber-700');
                saveBtn.classList.add('bg-slate-900');
            }

            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');

            // Limpiar productos y alerta Sampi al cerrar el modal de nueva carga
            if (id === 'bookingModal') {
                currentProducts = [];
                renderProductsTable();
                const sampiAlert = document.getElementById('sampiAlert');
                if (sampiAlert) sampiAlert.remove();
            }
        }

        function setModalMode(mode) {
            const dropTab = document.getElementById('tabDrop');
            const manualTab = document.getElementById('tabManual');
            const dropContent = document.getElementById('modeDrop');
            const manualForm = document.getElementById('bookingForm');

            if (mode === 'drop') {
                dropTab.className = 'flex-1 pb-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600';
                manualTab.className = 'flex-1 pb-2 text-sm font-medium text-slate-400';
                dropContent.classList.remove('hidden');
                manualForm.classList.add('hidden');
            } else {
                manualTab.className = 'flex-1 pb-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600';
                dropTab.className = 'flex-1 pb-2 text-sm font-medium text-slate-400';
                manualForm.classList.remove('hidden');
                dropContent.classList.add('hidden');
            }
        }

        // API Calls
        async function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('newKg').value = '';
            document.getElementById('newDuration').value = '30';

            const spinner = document.getElementById('uploadingSpinner');
            const content = document.getElementById('dropContent');
            spinner.classList.remove('hidden');
            content.classList.add('hidden');
            try {
                const formData = new FormData();
                formData.append('file', file);
                const res = await fetch('/api/bookings/upload.php', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                let data = {};
                try { data = await res.json(); } catch (_) { data = {}; }
                if (!res.ok) throw new Error(data.error || 'No se pudo leer el PDF');

                // Debug: mostrar qu√© parser se us√≥
                const parserSource = res.headers.get('X-Parser-Source');
                console.log(`üîç Parser utilizado: ${parserSource || 'unknown'}`);
                if (parserSource === 'local-php-fallback') {
                    console.warn('‚ö†Ô∏è ADVERTENCIA: Usando parser PHP local (fallback). El webhook n8n no respondi√≥ correctamente.');
                    console.log('üìã Verifica: https://pizarra-ventas.socialsflow.io/api/debug_env.php');
                }

                const result = Array.isArray(data) ? data[0] : data;
                if (result.client) document.getElementById('newClient').value = result.client;
                if (result.clientCode) document.getElementById('newClientCode').value = result.clientCode;
                if (result.orderNumber) document.getElementById('newOrderNumber').value = result.orderNumber;

                // Load products from PDF
                if (result.items && result.items.length > 0) {
                    currentProducts = result.items.map(item => ({
                        code: item.code,
                        qty: item.qty,
                        coef: item.coef,
                        kg: item.kg
                    }));
                    renderProductsTable();

                    // Check if webhook sent Sampi info
                    if (result.sampiInfo && result.sampiInfo.needsSampi) {
                        showSampiAlert(result.sampiInfo);
                    }
                } else {
                    // Fallback to manual kg entry
                    if (result.kg && result.kg < 50000) {
                        document.getElementById('newKg').value = result.kg;
                    }
                    if (result.duration) {
                        document.getElementById('newDuration').value = result.duration;
                    }
                }

                setModalMode('manual');

                // Mensaje de √©xito si se cargaron datos
                if (result.client || currentProducts.length > 0) {
                    const itemsCount = currentProducts.length;
                    const msg = itemsCount > 0
                        ? `‚úÖ PDF procesado: ${itemsCount} productos detectados`
                        : '‚úÖ Datos del pedido cargados';
                    console.log(msg);
                }
            } catch (err) {
                console.error(err);
                alert('‚ö†Ô∏è No se pudo leer el PDF completo. Puedes completar los datos manualmente.');
                setModalMode('manual');
            } finally {
                spinner.classList.add('hidden');
                content.classList.remove('hidden');
                e.target.value = ''; // Reset input
            }
        }

        async function handleCreateBooking(e) {
            e.preventDefault();

            const SAMPI_CODES = ['1011', '1015', '1016'];
            const SAMPI_THRESHOLD = 648;

            // Calcular kg: si hay productos usar el total calculado, sino usar el campo manual
            let totalKg = 0;
            if (currentProducts.length > 0) {
                totalKg = currentProducts.reduce((sum, p) => sum + p.kg, 0);
            } else {
                totalKg = parseFloat(document.getElementById('newKg').value) || 0;
            }

            // Base data for booking
            const baseData = {
                startTimeHour: parseInt(document.getElementById('newTimeSlotHour').value),
                startTimeMinute: parseInt(document.getElementById('newTimeSlotMinute').value),
                date: currentDate.toISOString().split('T')[0],
                client: document.getElementById('newClient').value,
                clientCode: document.getElementById('newClientCode').value || null,
                orderNumber: document.getElementById('newOrderNumber').value || null,
                color: document.getElementById('newColor').value
            };

            try {
                // Check if we need to split Sampi
                const sampiProducts = currentProducts.filter(p => SAMPI_CODES.includes(p.code));
                const sampiKg = sampiProducts.reduce((sum, p) => sum + p.kg, 0);

                if (sampiProducts.length > 0 && sampiKg > SAMPI_THRESHOLD) {
                    // SPLIT INTO TWO BOOKINGS
                    const regularProducts = currentProducts.filter(p => !SAMPI_CODES.includes(p.code));
                    const regularKg = regularProducts.reduce((sum, p) => sum + p.kg, 0);

                    // Calculate individual durations
                    const sampiDuration = calculateDuration(sampiKg);
                    const regularDuration = calculateDuration(regularKg);

                    // Booking 1: Regular products on Puerta
                    const puertaData = {
                        ...baseData,
                        resourceId: document.getElementById('newResourceId').value, // Original resource (Puerta)
                        kg: Math.round(regularKg * 100) / 100,
                        duration: regularDuration,
                        description: `${document.getElementById('newObservations').value || ''} [Productos regulares]`.trim()
                    };

                    // Booking 2: Sampi products on Sampi
                    const sampiData = {
                        ...baseData,
                        resourceId: 'sampi', // Force Sampi resource
                        kg: Math.round(sampiKg * 100) / 100,
                        duration: sampiDuration,
                        description: `${document.getElementById('newObservations').value || ''} [Productos Sampi: ${sampiProducts.map(p => p.code).join(', ')}]`.trim()
                    };

                    // Create both bookings
                    console.log(`üîÄ Divisi√≥n autom√°tica Sampi detectada:`);
                    console.log(`  üì¶ Puerta: ${regularKg.toFixed(0)}kg (${regularDuration}min) - ${regularProducts.length} productos`);
                    console.log(`  ‚öôÔ∏è Sampi: ${sampiKg.toFixed(0)}kg (${sampiDuration}min) - ${sampiProducts.length} productos`);

                    const [res1, res2] = await Promise.all([
                        fetch('/api/bookings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify(puertaData)
                        }),
                        fetch('/api/bookings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify(sampiData)
                        })
                    ]);

                    if (res1.ok && res2.ok) {
                        alert(`‚úÖ Carga dividida autom√°ticamente:\n\nüö™ Puerta: ${regularKg.toFixed(0)}kg (${regularDuration}min)\n‚öôÔ∏è Sampi: ${sampiKg.toFixed(0)}kg (${sampiDuration}min)`);
                        closeModal('bookingModal');
                        loadBookings();
                    } else {
                        throw new Error('Error al crear una o ambas cargas');
                    }
                } else {
                    // SINGLE BOOKING (normal flow)
                    const data = {
                        ...baseData,
                        resourceId: document.getElementById('newResourceId').value,
                        kg: Math.round(totalKg * 100) / 100,
                        duration: parseInt(document.getElementById('newDuration').value),
                        description: document.getElementById('newObservations').value || ''
                    };

                    const res = await fetch('/api/bookings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(data)
                    });

                    if (res.ok) {
                        closeModal('bookingModal');
                        loadBookings();
                    } else {
                        alert('Error al crear carga');
                    }
                }
            } catch (err) {
                console.error(err);
                alert('Error al crear carga: ' + err.message);
            }
        }

        // Helper function to calculate duration based on kg
        function calculateDuration(kg) {
            const KG_PER_HOUR = 2000;
            const hoursNeeded = kg / KG_PER_HOUR;
            const minutesNeeded = Math.ceil((hoursNeeded * 60) / 30) * 30;
            return Math.max(minutesNeeded, 30);
        }

        async function handleUpdateBooking(e) {
            e.preventDefault();
            const id = document.getElementById('editId').value;

            const data = {
                client: document.getElementById('editClient').value,
                kg: parseFloat(document.getElementById('editKg').value) || 0,
                description: document.getElementById('editDescription').value,
                duration: parseInt(document.getElementById('editDuration').value),
                color: document.getElementById('editColor').value,
                clientCode: document.getElementById('editClientCode').value || null,
                orderNumber: document.getElementById('editOrderNumber').value || null,
                realStartTime: document.getElementById('editRealStartTime').value,
                realEndTime: document.getElementById('editRealEndTime').value
            };
        try {
            const res = await fetch(`/api/bookings/manage.php?id=${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                closeModal('editModal');
                loadBookings();
            } else {
                alert('Error al actualizar carga');
            }
        } catch (err) { console.error(err); }
        }

        async function handleDeleteBooking() {
            if (!confirm('¬øEliminar carga?')) return;
            const id = document.getElementById('editId').value;
            try {
                const res = await fetch(`/api/bookings/manage.php?id=${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    closeModal('editModal');
                    loadBookings();
                } else {
                    alert('Error al eliminar carga');
                }
            } catch (err) { console.error(err); }
        }

        // === PRODUCTS TABLE FUNCTIONS ===

        function renderProductsTable() {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';

            currentProducts.forEach((product, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-blue-50 transition-colors';
                row.innerHTML = `
                    <td class="p-2">
                        <input type="text" value="${product.code}"
                            onchange="updateProductCode(${index}, this.value)"
                            class="w-full px-1.5 py-1 border border-slate-200 rounded text-xs font-mono focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </td>
                    <td class="p-2 text-right">
                        <input type="number" value="${product.qty}" min="1"
                            onchange="updateProductQty(${index}, this.value)"
                            class="w-full px-1.5 py-1 border border-slate-200 rounded text-xs text-right font-semibold focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </td>
                    <td class="p-2 text-right">
                        <input type="number" value="${product.coef}" min="0" step="0.01"
                            onchange="updateProductCoef(${index}, this.value)"
                            class="w-full px-1.5 py-1 border border-slate-200 rounded text-xs text-right text-slate-600 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </td>
                    <td class="p-2 text-right font-bold text-blue-700 bg-blue-50">
                        ${product.kg.toFixed(2)}
                    </td>
                    <td class="p-2 text-center">
                        <button type="button" onclick="removeProductRow(${index})"
                            class="text-red-400 hover:text-red-600 transition-colors p-1">
                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            lucide.createIcons();
            recalculateTotalKg();

            // Show/hide products section
            const hasProducts = currentProducts.length > 0;
            document.getElementById('productsSection').classList.toggle('hidden', !hasProducts);

            // Update product count badge
            document.getElementById('productCount').textContent = currentProducts.length;

            // Update Kg field state - readonly si hay productos
            const kgField = document.getElementById('newKg');
            const kgBadge = document.getElementById('kgBadge');
            if (hasProducts) {
                kgField.readOnly = true;
                kgField.classList.add('bg-slate-100', 'cursor-not-allowed', 'text-slate-600');
                kgBadge.classList.remove('hidden');
            } else {
                kgField.readOnly = false;
                kgField.classList.remove('bg-slate-100', 'cursor-not-allowed', 'text-slate-600');
                kgBadge.classList.add('hidden');
            }
        }

        function addProductRow() {
            currentProducts.push({
                code: '',
                qty: 1,
                coef: 1.0,
                kg: 1.0
            });
            renderProductsTable();
        }

        function removeProductRow(index) {
            currentProducts.splice(index, 1);
            renderProductsTable();
        }

        function updateProductCode(index, code) {
            currentProducts[index].code = code.toUpperCase();
            // Try to get coefficient from productMap
            if (productMap[code]) {
                currentProducts[index].coef = productMap[code];
            }
            updateProductKg(index);
        }

        function updateProductQty(index, qty) {
            currentProducts[index].qty = parseFloat(qty) || 0;
            updateProductKg(index);
        }

        function updateProductCoef(index, coef) {
            currentProducts[index].coef = parseFloat(coef) || 1;
            updateProductKg(index);
        }

        function updateProductKg(index) {
            const product = currentProducts[index];
            product.kg = product.qty * product.coef;
            renderProductsTable();
        }

        function recalculateTotalKg() {
            const total = currentProducts.reduce((sum, p) => sum + p.kg, 0);
            document.getElementById('totalKgDisplay').textContent = `${total.toFixed(2)} kg`;
            document.getElementById('newKg').value = Math.round(total);

            // Auto-calculate duration
            autoCalcDuration(total, 'newDuration');

            // Check Sampi logic
            showSampiNotification();
        }

        function autoCalcDuration(kg, targetId) {
            const KG_PER_HOUR = 2000; // Default from demo
            if (kg && kg > 0) {
                const hoursNeeded = kg / KG_PER_HOUR;
                const minutesNeeded = Math.ceil((hoursNeeded * 60) / 30) * 30;
                const suggested = Math.max(minutesNeeded, 30);
                document.getElementById(targetId).value = suggested;
            }
        }

        // Calculate end time automatically based on start time + duration
        function calculateEndTime() {
            const startTime = document.getElementById('editRealStartTime').value;
            const duration = parseInt(document.getElementById('editDuration').value);

            if (!startTime || !duration) {
                document.getElementById('editRealEndTimeDisplay').value = '';
                document.getElementById('editRealEndTime').value = '';
                return;
            }

            // Parse start time
            const [hours, minutes] = startTime.split(':').map(Number);
            const startDate = new Date();
            startDate.setHours(hours, minutes, 0, 0);

            // Add duration
            const endDate = new Date(startDate.getTime() + duration * 60000);
            const endHours = String(endDate.getHours()).padStart(2, '0');
            const endMinutes = String(endDate.getMinutes()).padStart(2, '0');
            const endTimeStr = `${endHours}:${endMinutes}`;

            document.getElementById('editRealEndTimeDisplay').value = endTimeStr;
            document.getElementById('editRealEndTime').value = endTimeStr;
        }

        // === L√ìGICA SAMPI ===
        // Detecta si hay productos que deben ir al Sampi
        // C√≥digos: 1011, 1015, 1016 > 648kg total ‚Üí asignar al Sampi
        function checkSampiLogic() {
            const SAMPI_CODES = ['1011', '1015', '1016'];
            const SAMPI_THRESHOLD = 648; // kg

            let sampiKg = 0;
            const sampiProducts = [];

            currentProducts.forEach(product => {
                if (SAMPI_CODES.includes(product.code)) {
                    sampiKg += product.kg;
                    sampiProducts.push(product);
                }
            });

            // Si excede el umbral, mostrar alerta
            if (sampiKg > SAMPI_THRESHOLD) {
                return {
                    needsSampi: true,
                    sampiKg: sampiKg,
                    sampiProducts: sampiProducts,
                    regularKg: currentProducts.reduce((sum, p) => sum + p.kg, 0) - sampiKg
                };
            }

            return { needsSampi: false };
        }

        // Mostrar notificaci√≥n Sampi si es necesario
        function showSampiNotification() {
            const sampiCheck = checkSampiLogic();

            if (sampiCheck.needsSampi) {
                const msg = `‚öôÔ∏è ATENCI√ìN: Detectados ${sampiCheck.sampiKg.toFixed(0)}kg de productos Sampi (1011, 1015, 1016).\n\n` +
                            `Se recomienda asignar estos productos al Sampi:\n` +
                            `- Sampi: ${sampiCheck.sampiKg.toFixed(0)}kg\n` +
                            `- Puerta: ${sampiCheck.regularKg.toFixed(0)}kg`;

                console.log(msg);
                showSampiAlert({
                    sampiKg: sampiCheck.sampiKg,
                    regularKg: sampiCheck.regularKg,
                    message: msg
                });
            }
        }

        // Mostrar alerta visual Sampi (llamada desde webhook o check manual)
        function showSampiAlert(sampiInfo) {
            // Remover alerta anterior si existe
            const existingAlert = document.getElementById('sampiAlert');
            if (existingAlert) existingAlert.remove();

            // Crear alerta visual profesional
            const alertDiv = document.createElement('div');
            alertDiv.id = 'sampiAlert';
            alertDiv.className = 'relative overflow-hidden bg-gradient-to-r from-orange-50 via-amber-50 to-orange-50 border-2 border-orange-400 rounded-lg p-4 mb-3 shadow-lg';
            alertDiv.innerHTML = `
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-400 via-amber-400 to-orange-400 animate-pulse"></div>
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center text-white text-xl shadow-md">
                        ‚öôÔ∏è
                    </div>
                    <div class="flex-1">
                        <h4 class="font-bold text-orange-900 text-sm mb-2 flex items-center gap-2">
                            ‚ö†Ô∏è ATENCI√ìN: Carga requiere Sampi
                            <span class="text-[10px] bg-orange-200 text-orange-800 px-2 py-0.5 rounded-full font-normal">Importante</span>
                        </h4>
                        <p class="text-xs text-orange-800 mb-3 leading-relaxed">
                            Se detectaron <strong class="text-orange-900 font-bold">${sampiInfo.sampiKg.toFixed(0)}kg</strong> de productos Sampi (c√≥digos 1011, 1015, 1016) que superan el umbral de 648kg.
                        </p>
                        <div class="grid grid-cols-2 gap-2 text-xs mb-3">
                            <div class="bg-white bg-opacity-50 p-2 rounded border border-orange-200">
                                <div class="text-orange-600 font-semibold mb-1">‚öôÔ∏è Sampi</div>
                                <div class="text-orange-900 font-bold text-base">${sampiInfo.sampiKg.toFixed(0)} kg</div>
                            </div>
                            <div class="bg-white bg-opacity-50 p-2 rounded border border-orange-200">
                                <div class="text-orange-600 font-semibold mb-1">üö™ Puerta</div>
                                <div class="text-orange-900 font-bold text-base">${sampiInfo.regularKg.toFixed(0)} kg</div>
                            </div>
                        </div>
                        <div class="bg-green-100 border border-green-300 rounded p-2">
                            <p class="text-[10px] text-green-800 font-semibold flex items-center gap-1">
                                ‚ú® Al confirmar se crear√°n autom√°ticamente 2 cargas:
                            </p>
                            <p class="text-[10px] text-green-700 mt-1 ml-3">
                                ‚Ä¢ Puerta (${sampiInfo.regularKg.toFixed(0)}kg) + Sampi (${sampiInfo.sampiKg.toFixed(0)}kg)
                            </p>
                        </div>
                    </div>
                    <button onclick="document.getElementById('sampiAlert').remove()"
                        class="flex-shrink-0 text-orange-400 hover:text-orange-600 transition-colors font-bold text-lg">‚úï</button>
                </div>
            `;

            // Insertar despu√©s de la tabla de productos
            const productsSection = document.getElementById('productsSection');
            productsSection.parentNode.insertBefore(alertDiv, productsSection.nextSibling);
        }

        // ========== BULK UPLOAD FUNCTIONS ==========
        let bulkOrders = [];

        function openBulkUploadModal() {
            document.getElementById('bulkStep1').classList.remove('hidden');
            document.getElementById('bulkStep2').classList.add('hidden');
            document.getElementById('bulkDate').value = currentDate.toISOString().split('T')[0];
            document.getElementById('bulkUploadModal').classList.remove('hidden');
            document.getElementById('bulkUploadModal').classList.add('flex');
            bulkOrders = [];
            lucide.createIcons();
        }

        async function handleBulkExcelUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const spinner = document.getElementById('bulkUploadingSpinner');
            const content = document.getElementById('bulkDropContent');
            spinner.classList.remove('hidden');
            content.classList.add('hidden');

            try {
                const formData = new FormData();
                formData.append('file', file);

                const res = await fetch('/api/bookings/bulk-upload.php', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Error al procesar Excel');
                }

                if (!data.orders || data.orders.length === 0) {
                    throw new Error('No se encontraron pedidos en el archivo');
                }

                // Store orders and show step 2
                bulkOrders = data.orders.map((order, index) => ({
                    ...order,
                    index,
                    selected: true,
                    resourceId: 'p1', // Default to Puerta 1
                    startTimeHour: 8, // Default 08:00
                    startTimeMinute: 0,
                    duration: order.suggestedDuration || 30
                }));

                document.getElementById('bulkOrderCount').textContent = bulkOrders.length;
                renderBulkOrdersTable();

                document.getElementById('bulkStep1').classList.add('hidden');
                document.getElementById('bulkStep2').classList.remove('hidden');
                lucide.createIcons();

            } catch (err) {
                console.error(err);
                alert('‚ùå ' + err.message);
            } finally {
                spinner.classList.add('hidden');
                content.classList.remove('hidden');
                e.target.value = '';
            }
        }

        function backToBulkUpload() {
            document.getElementById('bulkStep2').classList.add('hidden');
            document.getElementById('bulkStep1').classList.remove('hidden');
            bulkOrders = [];
        }

        function renderBulkOrdersTable() {
            const tbody = document.getElementById('bulkOrdersTableBody');
            tbody.innerHTML = '';

            bulkOrders.forEach((order, idx) => {
                const row = document.createElement('tr');
                row.className = `${order.selected ? 'bg-white' : 'bg-slate-50 opacity-60'} hover:bg-blue-50 transition-colors`;

                const clientDisplay = `${order.clientCode ? `<span class="inline-block px-1.5 py-0.5 bg-slate-200 rounded text-xs font-mono mr-1">${order.clientCode}</span>` : ''}${order.client || 'Sin nombre'}`;
                const descDisplay = order.description ? `<span class="text-xs text-slate-600">${order.description}</span>` : '';

                row.innerHTML = `
                    <td class="p-3">
                        <input type="checkbox" ${order.selected ? 'checked' : ''}
                            onchange="toggleOrderSelection(${idx}, this.checked)"
                            class="w-4 h-4">
                    </td>
                    <td class="p-3 font-semibold">${clientDisplay}</td>
                    <td class="p-3">
                        <span class="font-mono text-sm bg-blue-100 text-blue-800 px-2 py-0.5 rounded">${order.orderNumber || 'N/A'}</span>
                    </td>
                    <td class="p-3 text-right">
                        <span class="font-bold text-blue-700">${order.kg} kg</span>
                    </td>
                    <td class="p-3 text-xs text-slate-600">${descDisplay}</td>
                    <td class="p-3">
                        <select onchange="updateOrderField(${idx}, 'resourceId', this.value)"
                            class="w-full p-1.5 border border-slate-300 rounded text-xs">
                            <option value="p1" ${order.resourceId === 'p1' ? 'selected' : ''}>Puerta 1</option>
                            <option value="p2" ${order.resourceId === 'p2' ? 'selected' : ''}>Puerta 2</option>
                            <option value="p3" ${order.resourceId === 'p3' ? 'selected' : ''}>Puerta 3</option>
                            <option value="p4" ${order.resourceId === 'p4' ? 'selected' : ''}>Puerta 4</option>
                            <option value="sampi" ${order.resourceId === 'sampi' ? 'selected' : ''}>Sampi</option>
                        </select>
                    </td>
                    <td class="p-3">
                        <input type="time" value="${String(order.startTimeHour).padStart(2,'0')}:${String(order.startTimeMinute).padStart(2,'0')}"
                            onchange="updateOrderTime(${idx}, this.value)"
                            class="w-full p-1.5 border border-slate-300 rounded text-xs font-mono">
                    </td>
                    <td class="p-3">
                        <select onchange="updateOrderField(${idx}, 'duration', parseInt(this.value))"
                            class="w-full p-1.5 border border-slate-300 rounded text-xs">
                            <option value="30" ${order.duration === 30 ? 'selected' : ''}>30m</option>
                            <option value="60" ${order.duration === 60 ? 'selected' : ''}>1h</option>
                            <option value="90" ${order.duration === 90 ? 'selected' : ''}>1h 30m</option>
                            <option value="120" ${order.duration === 120 ? 'selected' : ''}>2h</option>
                            <option value="150" ${order.duration === 150 ? 'selected' : ''}>2h 30m</option>
                            <option value="180" ${order.duration === 180 ? 'selected' : ''}>3h</option>
                            <option value="240" ${order.duration === 240 ? 'selected' : ''}>4h</option>
                            <option value="300" ${order.duration === 300 ? 'selected' : ''}>5h</option>
                        </select>
                    </td>
                    <td class="p-3 text-center">
                        <button onclick="copyOrderConfig(${idx})"
                            title="Copiar configuraci√≥n"
                            class="text-blue-500 hover:text-blue-700 transition">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            lucide.createIcons();
            updateSelectedCount();
        }

        function toggleOrderSelection(idx, selected) {
            bulkOrders[idx].selected = selected;
            renderBulkOrdersTable();
        }

        function toggleAllOrders(checked) {
            bulkOrders.forEach(order => order.selected = checked);
            renderBulkOrdersTable();
        }

        function updateOrderField(idx, field, value) {
            bulkOrders[idx][field] = value;
            renderBulkOrdersTable();
        }

        function updateOrderTime(idx, timeValue) {
            const [hour, minute] = timeValue.split(':').map(Number);
            bulkOrders[idx].startTimeHour = hour;
            bulkOrders[idx].startTimeMinute = minute;
        }

        let copiedConfig = null;
        function copyOrderConfig(idx) {
            copiedConfig = {
                resourceId: bulkOrders[idx].resourceId,
                startTimeHour: bulkOrders[idx].startTimeHour,
                startTimeMinute: bulkOrders[idx].startTimeMinute,
                duration: bulkOrders[idx].duration
            };
            alert('‚úÖ Configuraci√≥n copiada. Haz click en "Pegar" en otro pedido para aplicarla.');
        }

        function applyDateToAll() {
            const date = document.getElementById('bulkDate').value;
            if (date) {
                alert(`Fecha ${date} lista para aplicar a todos los pedidos`);
            }
        }

        function updateSelectedCount() {
            const count = bulkOrders.filter(o => o.selected).length;
            document.getElementById('selectedOrdersCount').textContent = count;
        }

        async function confirmBulkCreate() {
            const selectedOrders = bulkOrders.filter(o => o.selected);

            if (selectedOrders.length === 0) {
                alert('‚ö†Ô∏è Debes seleccionar al menos un pedido');
                return;
            }

            const date = document.getElementById('bulkDate').value;
            if (!date) {
                alert('‚ö†Ô∏è Debes seleccionar una fecha');
                return;
            }

            // Prepare bookings for API
            const bookings = selectedOrders.map(order => ({
                client: order.client,
                clientCode: order.clientCode,
                orderNumber: order.orderNumber,
                description: order.description,
                kg: order.kg,
                duration: order.duration,
                color: 'blue',
                resourceId: order.resourceId,
                startTimeHour: order.startTimeHour,
                startTimeMinute: order.startTimeMinute,
                items: order.items || []
            }));

            // Show loading
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-pulse">Creando pedidos...</span>';

            try {
                const res = await fetch('/api/bookings/bulk-create.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ bookings, date })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Error al crear pedidos');
                }

                // Show results
                const summary = data.summary;
                let message = `‚úÖ Carga masiva completada:\n\n`;
                message += `üì¶ ${summary.created} pedidos creados\n`;

                if (summary.errors > 0) {
                    message += `‚ùå ${summary.errors} errores\n`;
                }
                if (summary.warnings > 0) {
                    message += `‚ö†Ô∏è ${summary.warnings} advertencias\n`;
                }

                // Show errors if any
                if (data.errors.length > 0) {
                    message += `\nüîç Errores:\n`;
                    data.errors.slice(0, 5).forEach(err => {
                        const order = err.booking;
                        message += `- ${order.client || 'Sin nombre'} (${order.orderNumber || 'N/A'}): ${err.error}\n`;
                    });
                    if (data.errors.length > 5) {
                        message += `... y ${data.errors.length - 5} m√°s\n`;
                    }
                }

                alert(message);

                // Reload bookings and close modal
                await loadBookings();
                closeModal('bulkUploadModal');

            } catch (err) {
                console.error(err);
                alert('‚ùå Error: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="flex items-center justify-center gap-2"><i data-lucide="check-circle" class="w-5 h-5"></i>Crear <span id="selectedOrdersCount">' + selectedOrders.length + '</span> Pedidos Seleccionados</span>';
                lucide.createIcons();
            }
        }
    </script>
</body>

</html>
