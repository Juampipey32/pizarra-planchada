<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizarra Log铆stica - Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SortableJS para Drag & Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.css"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* Estilos personalizados para complementar Tailwind */
        .kanban-col {
            min-height: 200px; /* Altura m铆nima para permitir soltar items en columnas vac铆as */
            transition: background-color 0.2s;
        }
        .kanban-col.sortable-drag-over {
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .card-item {
            touch-action: manipulation; /* Mejorar tactil */
            cursor: grab;
        }
        .card-item:active {
            cursor: grabbing;
        }
        /* Ocultar scrollbar pero permitir scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Loader */
        #loader {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        /* Clases para estados visuales */
        .status-planned { border-left: 4px solid #3b82f6; } /* Blue */
        .status-loaded { border-left: 4px solid #22c55e; } /* Green */
        .status-issue { border-left: 4px solid #ef4444; } /* Red */
        
        /* Solo lectura (Planchada) */
        .readonly-mode .card-item { cursor: default !important; }
        .readonly-mode .action-btn { display: none !important; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Loader -->
    <div id="loader">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600"></div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm z-10 shrink-0">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-4">
                    <div class="flex-shrink-0 flex items-center gap-2 text-blue-600">
                        <i class="fa-solid fa-truck-ramp-box text-2xl"></i>
                        <span class="font-bold text-xl tracking-tight hidden sm:block">LOGSTICA COSALTA</span>
                    </div>
                    <!-- Date Picker -->
                    <div class="flex items-center bg-slate-100 rounded-lg p-1">
                        <button id="prevDayBtn" class="p-2 hover:bg-white rounded-md text-slate-500 transition-colors"><i class="fa-solid fa-chevron-left"></i></button>
                        <input type="date" id="currentDate" class="bg-transparent border-0 focus:ring-0 text-sm font-medium text-slate-700 w-32 text-center">
                        <button id="nextDayBtn" class="p-2 hover:bg-white rounded-md text-slate-500 transition-colors"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <span id="userInfo" class="text-sm font-medium text-slate-600 hidden md:block">Cargando...</span>
                    
                    <!-- Admin Controls (Ocultos por defecto) -->
                    <div id="adminControls" class="hidden flex gap-2">
                        <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-medium shadow-sm transition-all flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">Nuevo</span>
                        </button>
                        <div class="relative group">
                            <button class="bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 px-3 py-2 rounded-lg text-sm font-medium shadow-sm transition-all">
                                <i class="fa-solid fa-gear"></i>
                            </button>
                            <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden group-hover:block border border-slate-100">
                                <a href="admin-users.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Usuarios</a>
                                <a href="admin-products.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Productos</a>
                            </div>
                        </div>
                    </div>

                    <button onclick="logout()" class="text-slate-400 hover:text-red-500 p-2 transition-colors" title="Cerrar Sesi贸n">
                        <i class="fa-solid fa-arrow-right-from-bracket text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Board Area -->
    <main class="flex-1 overflow-x-auto overflow-y-hidden p-4">
        <div class="h-full flex gap-4 min-w-max" id="boardContainer">
            <!-- Columns will be injected here by JS -->
        </div>
    </main>

    <!-- Create/Edit Booking Modal -->
    <div id="bookingModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-slate-800" id="modalTitle">Nuevo Pedido</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <form id="bookingForm" class="p-6 overflow-y-auto space-y-4">
                <input type="hidden" id="bookingId">
                
                <!-- Cliente Search -->
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Cliente</label>
                    <div class="relative">
                        <i class="fa-solid fa-user absolute left-3 top-3 text-slate-400"></i>
                        <input type="text" id="clientName" required
                            class="w-full pl-10 pr-4 py-2 rounded-lg border-slate-200 focus:border-blue-500 focus:ring-blue-500 text-sm"
                            placeholder="Buscar o escribir nombre...">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">C贸d. Cliente</label>
                        <input type="text" id="clientCode" class="w-full px-3 py-2 rounded-lg border-slate-200 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">N掳 Pedido</label>
                        <input type="text" id="orderNumber" class="w-full px-3 py-2 rounded-lg border-slate-200 text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Hora Inicio</label>
                        <input type="time" id="startTime" required class="w-full px-3 py-2 rounded-lg border-slate-200 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Duraci贸n (min)</label>
                        <input type="number" id="duration" required min="15" step="15" value="30" 
                            class="w-full px-3 py-2 rounded-lg border-slate-200 text-sm">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Recurso (Puerta)</label>
                    <select id="resourceSelect" class="w-full px-3 py-2 rounded-lg border-slate-200 text-sm bg-white">
                        <!-- Options filled by JS -->
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Kilos (kg)</label>
                        <input type="number" id="kg" step="0.01" class="w-full px-3 py-2 rounded-lg border-slate-200 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Color Etiqueta</label>
                        <div class="flex gap-2 mt-1">
                            <button type="button" onclick="selectColor('blue')" class="w-6 h-6 rounded-full bg-blue-500 hover:ring-2 ring-offset-1 ring-blue-500 color-opt" data-color="blue"></button>
                            <button type="button" onclick="selectColor('green')" class="w-6 h-6 rounded-full bg-green-500 hover:ring-2 ring-offset-1 ring-green-500 color-opt" data-color="green"></button>
                            <button type="button" onclick="selectColor('red')" class="w-6 h-6 rounded-full bg-red-500 hover:ring-2 ring-offset-1 ring-red-500 color-opt" data-color="red"></button>
                            <button type="button" onclick="selectColor('purple')" class="w-6 h-6 rounded-full bg-purple-500 hover:ring-2 ring-offset-1 ring-purple-500 color-opt" data-color="purple"></button>
                            <input type="hidden" id="selectedColor" value="blue">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Detalles / Carga</label>
                    <textarea id="description" rows="3" class="w-full px-3 py-2 rounded-lg border-slate-200 text-sm resize-none"></textarea>
                </div>
            </form>
            
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-between rounded-b-xl">
                 <button type="button" id="deleteBtn" onclick="deleteBooking()" class="hidden text-red-600 hover:bg-red-50 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    <i class="fa-solid fa-trash mr-1"></i> Eliminar
                </button>
                <div class="flex gap-3 ml-auto">
                    <button type="button" onclick="closeModal()" class="text-slate-600 hover:bg-slate-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">Cancelar</button>
                    <button type="button" onclick="saveBooking()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-sm transition-all transform active:scale-95">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Logic -->
    <script>
        // CONFIGURACIN
        const API_URL = '/api/bookings'; 
        // Definici贸n de Recursos (Puertas)
        const RESOURCES = [
            { id: 'PENDIENTE', name: ' PENDIENTE', color: 'bg-yellow-50' }, // Bandeja de entrada
            { id: '1', name: 'Puerta 1', color: 'bg-slate-50' },
            { id: '2', name: 'Puerta 2', color: 'bg-slate-50' },
            { id: '3', name: 'Puerta 3', color: 'bg-slate-50' },
            { id: '4', name: 'Puerta 4', color: 'bg-slate-50' },
            { id: '5', name: 'Puerta 5', color: 'bg-slate-50' },
            { id: 'sampi', name: ' SAMPI', color: 'bg-purple-50' } // Recurso especial
        ];

        // ESTADO GLOBAL
        let currentUser = null;
        let currentDate = new Date().toISOString().split('T')[0];
        let bookings = [];
        let sortables = [];

        // Helper para redirecci贸n segura (evita errores en entornos de vista previa)
        function redirectToLogin() {
            try {
                window.location.href = 'index.html';
            } catch (e) {
                console.warn("No se pudo redirigir (Entorno de pruebas):", e);
                document.getElementById('loader').style.display = 'none';
                Swal.fire({
                    title: 'Acceso Denegado',
                    text: 'No hay sesi贸n activa. En producci贸n, esto redirigir铆a al Login. 驴Deseas simular un acceso Admin para probar?',
                    icon: 'warning',
                    confirmButtonText: 'Simular Login Admin',
                    showCancelButton: true,
                    cancelButtonText: 'Cerrar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        mockLogin();
                    }
                });
            }
        }

        // Mock Login para pruebas r谩pidas en el entorno immersive
        function mockLogin() {
            // Token falso pero con estructura v谩lida para pasar el decoder
            const header = btoa(JSON.stringify({alg: "HS256", typ: "JWT"}));
            const payload = btoa(JSON.stringify({
                sub: "999",
                username: "AdminTest",
                role: "ADMIN",
                iat: Date.now() / 1000,
                exp: (Date.now() / 1000) + 3600
            }));
            const signature = "dummy_signature";
            const mockToken = `${header}.${payload}.${signature}`;
            localStorage.setItem('token', mockToken);
            window.location.reload();
        }

        // INICIALIZACIN
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Verificar Autenticaci贸n
            const token = localStorage.getItem('token');
            if (!token) {
                redirectToLogin();
                return;
            }

            // 2. Decodificar Token (Seguro)
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                currentUser = JSON.parse(jsonPayload);
                console.log(" Usuario Logueado:", currentUser); // DEBUG: Ver rol en consola

                // Validar Expiraci贸n
                if (Date.now() >= currentUser.exp * 1000) {
                    throw new Error("Token expirado");
                }

            } catch (e) {
                console.error("Error token:", e);
                localStorage.removeItem('token');
                redirectToLogin();
                return;
            }

            // 3. Configurar UI seg煤n Rol
            setupUIByRole();

            // 4. Inicializar Fecha y Tablero
            document.getElementById('currentDate').value = currentDate;
            initBoardLayout();
            await fetchBookings();
            
            // 5. Event Listeners de Fecha
            document.getElementById('currentDate').addEventListener('change', (e) => {
                currentDate = e.target.value;
                fetchBookings();
            });
            document.getElementById('prevDayBtn').addEventListener('click', () => changeDay(-1));
            document.getElementById('nextDayBtn').addEventListener('click', () => changeDay(1));

            // Quitar Loader
            document.getElementById('loader').style.display = 'none';
        });

        // --- LGICA DE ROLES ---
        function setupUIByRole() {
            const role = currentUser.role || 'PLANCHADA';
            document.getElementById('userInfo').textContent = `${currentUser.username} (${role})`;

            const isAdmin = role === 'ADMIN';
            const isLogistica = role === 'LOGISTICA';
            const canEdit = isAdmin || isLogistica;

            if (canEdit) {
                document.getElementById('adminControls').classList.remove('hidden');
                document.body.classList.remove('readonly-mode');
            } else {
                document.getElementById('adminControls').classList.add('hidden');
                document.body.classList.add('readonly-mode');
                // Nota: CSS .readonly-mode deshabilita punteros, pero SortableJS se deshabilita abajo
            }
        }

        // --- TABLERO KANBAN ---
        function initBoardLayout() {
            const container = document.getElementById('boardContainer');
            container.innerHTML = '';
            const select = document.getElementById('resourceSelect');
            select.innerHTML = '';

            RESOURCES.forEach(res => {
                // Agregar al Select del Modal
                const option = document.createElement('option');
                option.value = res.id;
                option.textContent = res.name;
                select.appendChild(option);

                // Crear Columna
                const colDiv = document.createElement('div');
                colDiv.className = `flex flex-col w-72 h-full rounded-xl border border-slate-200 shadow-sm shrink-0 bg-white overflow-hidden`;
                
                // Header Columna
                colDiv.innerHTML = `
                    <div class="p-3 border-b border-slate-100 flex justify-between items-center ${res.color}">
                        <h2 class="font-bold text-slate-700">${res.name}</h2>
                        <span class="text-xs font-mono bg-white px-2 py-0.5 rounded text-slate-500 count-badge" id="count-${res.id}">0</span>
                    </div>
                    <div class="flex-1 p-2 overflow-y-auto kanban-col no-scrollbar" id="col-${res.id}" data-resource="${res.id}">
                        <!-- Tarjetas aqu铆 -->
                    </div>
                `;
                container.appendChild(colDiv);

                // Inicializar Drag & Drop
                initSortable(document.getElementById(`col-${res.id}`));
            });
        }

        function initSortable(el) {
            const canEdit = currentUser.role === 'ADMIN' || currentUser.role === 'LOGISTICA';

            sortables.push(new Sortable(el, {
                group: 'shared', // Permite mover entre columnas
                animation: 150,
                disabled: !canEdit, // Deshabilitar si es Planchada
                ghostClass: 'bg-blue-50',
                delay: 100, // Prevenir arrastre accidental en touch
                delayOnTouchOnly: true,
                onEnd: function (evt) {
                    const itemEl = evt.item;
                    const newResourceId = evt.to.getAttribute('data-resource');
                    const oldResourceId = evt.from.getAttribute('data-resource');
                    const bookingId = itemEl.getAttribute('data-id');

                    // Solo actualizar si cambi贸 de columna
                    if (newResourceId !== oldResourceId) {
                        updateBookingResource(bookingId, newResourceId);
                    }
                }
            }));
        }

        // --- API & DATOS ---
        async function fetchBookings() {
            try {
                // Mostrar spinner suave en columnas? Opcional.
                
                const response = await fetch(`${API_URL}/index.php?date=${currentDate}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                if (!response.ok) throw new Error('Error al cargar datos');
                
                const data = await response.json();
                bookings = data; // Guardar en memoria
                renderBookings();

            } catch (error) {
                // Omitir error de JSON si es mock
                if(error.message.includes('JSON')) return;
                Swal.fire('Error', error.message, 'error');
            }
        }

        function renderBookings() {
            // Limpiar columnas
            RESOURCES.forEach(res => {
                document.getElementById(`col-${res.id}`).innerHTML = '';
                document.getElementById(`count-${res.id}`).textContent = '0';
            });

            // Llenar columnas
            bookings.forEach(booking => {
                const col = document.getElementById(`col-${booking.resourceId}`);
                if (col) {
                    const card = createCardElement(booking);
                    col.appendChild(card);
                }
            });

            // Actualizar contadores
            RESOURCES.forEach(res => {
                const count = document.getElementById(`col-${res.id}`).children.length;
                document.getElementById(`count-${res.id}`).textContent = count;
            });
        }

        function createCardElement(booking) {
            const div = document.createElement('div');
            // Formatear hora: 8:0 -> 08:00
            const timeStr = `${booking.startTimeHour.toString().padStart(2,'0')}:${booking.startTimeMinute.toString().padStart(2,'0')}`;
            
            // Colores
            const colorClasses = {
                'blue': 'bg-white border-l-4 border-blue-500',
                'green': 'bg-white border-l-4 border-green-500',
                'red': 'bg-white border-l-4 border-red-500',
                'purple': 'bg-white border-l-4 border-purple-500',
            };
            const bgClass = colorClasses[booking.color] || colorClasses['blue'];

            div.className = `p-3 mb-3 rounded-lg shadow-sm border border-slate-200 card-item relative group hover:shadow-md transition-shadow ${bgClass}`;
            div.setAttribute('data-id', booking.id);
            
            // Icono de editar (Solo visible si tiene permisos)
            const editBtn = (currentUser.role === 'ADMIN' || currentUser.role === 'LOGISTICA') 
                ? `<button onclick="editBooking(${booking.id})" class="absolute top-2 right-2 text-slate-300 hover:text-blue-600 action-btn p-1"><i class="fa-solid fa-pen-to-square"></i></button>` 
                : '';

            div.innerHTML = `
                <div class="flex justify-between items-start mb-1 pr-6">
                    <span class="font-bold text-slate-800 text-sm leading-tight">${booking.client}</span>
                </div>
                ${editBtn}
                <div class="flex items-center gap-2 text-xs text-slate-500 mb-2">
                    <span class="bg-slate-100 px-1.5 py-0.5 rounded font-mono text-slate-700 font-semibold"><i class="fa-regular fa-clock mr-1"></i>${timeStr}</span>
                    <span>${booking.duration} min</span>
                </div>
                
                ${booking.description ? `<p class="text-xs text-slate-600 mb-2 line-clamp-2 bg-slate-50 p-1 rounded">${booking.description}</p>` : ''}

                <div class="flex justify-between items-center border-t border-slate-100 pt-2 mt-1">
                     <span class="text-xs font-semibold text-slate-500">
                        ${booking.clientCode ? `<span class="bg-yellow-50 text-yellow-700 px-1 rounded mr-1">${booking.clientCode}</span>` : ''}
                        ${booking.orderNumber ? `#${booking.orderNumber}` : ''}
                    </span>
                    <span class="text-xs font-bold text-slate-700">${parseFloat(booking.kg).toLocaleString()} kg</span>
                </div>
            `;
            return div;
        }

        // --- ACCIONES (CRUD) ---

        async function updateBookingResource(id, newResourceId) {
            // Actualizaci贸n optimista: Ya se movi贸 en la UI, enviamos al server
            try {
                const response = await fetch(`${API_URL}/manage.php`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ id: id, resourceId: newResourceId })
                });

                if (!response.ok) {
                    throw new Error('Fall贸 la actualizaci贸n');
                    fetchBookings(); // Revertir si falla
                }
            } catch (error) {
                console.error(error);
                fetchBookings(); // Revertir
                Swal.fire('Error', 'No se pudo mover la tarjeta', 'error');
            }
        }

        window.openModal = function() {
            document.getElementById('bookingForm').reset();
            document.getElementById('bookingId').value = '';
            document.getElementById('deleteBtn').classList.add('hidden');
            document.getElementById('modalTitle').textContent = 'Nuevo Pedido';
            document.getElementById('resourceSelect').value = 'PENDIENTE'; // Default
            document.getElementById('bookingModal').classList.remove('hidden');
        }

        window.closeModal = function() {
            document.getElementById('bookingModal').classList.add('hidden');
        }

        window.editBooking = function(id) {
            const booking = bookings.find(b => b.id == id);
            if (!booking) return;

            document.getElementById('bookingId').value = booking.id;
            document.getElementById('clientName').value = booking.client;
            document.getElementById('clientCode').value = booking.clientCode || '';
            document.getElementById('orderNumber').value = booking.orderNumber || '';
            document.getElementById('description').value = booking.description || '';
            document.getElementById('kg').value = booking.kg;
            document.getElementById('duration').value = booking.duration;
            document.getElementById('resourceSelect').value = booking.resourceId;
            
            // Hora
            const hh = booking.startTimeHour.toString().padStart(2,'0');
            const mm = booking.startTimeMinute.toString().padStart(2,'0');
            document.getElementById('startTime').value = `${hh}:${mm}`;

            // Color
            selectColor(booking.color || 'blue');

            document.getElementById('deleteBtn').classList.remove('hidden');
            document.getElementById('modalTitle').textContent = 'Editar Pedido';
            document.getElementById('bookingModal').classList.remove('hidden');
        }

        window.saveBooking = async function() {
            const id = document.getElementById('bookingId').value;
            const timeParts = document.getElementById('startTime').value.split(':');
            
            const payload = {
                client: document.getElementById('clientName').value,
                clientCode: document.getElementById('clientCode').value,
                orderNumber: document.getElementById('orderNumber').value,
                description: document.getElementById('description').value,
                kg: document.getElementById('kg').value,
                duration: document.getElementById('duration').value,
                resourceId: document.getElementById('resourceSelect').value,
                date: currentDate,
                startTimeHour: parseInt(timeParts[0]),
                startTimeMinute: parseInt(timeParts[1]),
                color: document.getElementById('selectedColor').value
            };

            const method = id ? 'PUT' : 'POST';
            if (id) payload.id = id;

            try {
                const response = await fetch(`${API_URL}/manage.php`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(payload)
                });

                const resData = await response.json();
                if (!response.ok) throw new Error(resData.error || 'Error al guardar');

                closeModal();
                fetchBookings();
                Swal.fire({
                    icon: 'success',
                    title: 'Guardado',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });

            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        }

        window.deleteBooking = async function() {
            const id = document.getElementById('bookingId').value;
            if (!id) return;

            const result = await Swal.fire({
                title: '驴Eliminar pedido?',
                text: "No podr谩s revertir esto",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'S铆, eliminar'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(`${API_URL}/manage.php`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ id: id })
                    });

                    if (!response.ok) throw new Error('Error al eliminar');

                    closeModal();
                    fetchBookings();
                    Swal.fire('Eliminado', 'El pedido ha sido eliminado.', 'success');

                } catch (error) {
                    Swal.fire('Error', error.message, 'error');
                }
            }
        }

        // Helpers
        function changeDay(delta) {
            const date = new Date(currentDate);
            date.setDate(date.getDate() + delta);
            currentDate = date.toISOString().split('T')[0];
            document.getElementById('currentDate').value = currentDate;
            fetchBookings();
        }

        window.selectColor = function(color) {
            document.getElementById('selectedColor').value = color;
            // Visual feedback
            document.querySelectorAll('.color-opt').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2');
                if (btn.dataset.color === color) {
                    btn.classList.add('ring-2', 'ring-offset-2', 'ring-gray-400');
                }
            });
        }

        window.logout = function() {
            localStorage.removeItem('token');
            redirectToLogin();
        }
    </script>
</body>
</html>
